<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <style>

   body {
     font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
     margin: auto;
     position: relative;
     width: 960px;
   }

   text {
     font: 10px sans-serif;
   }

   .axis path,
   .axis line {
     fill: none;
     stroke: #000;
     shape-rendering: crispEdges;
   }

   form {
     position: absolute;
     right: 10px;
     top: 10px;
   }

   .node {
   	 stroke: #fff;
   	 stroke-width: 1.5px;
   }

   .link {
	 stroke: #999;
	 stroke-opacity: .6;
   }

  </style>
  <form>
    <label><input type="radio" name="mode" value="grouped"> Grouped</label>
    <label><input type="radio" name="mode" value="stacked" checked> Stacked</label>
  </form>
  <head>
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
    <script src="http://apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="file:///Users/Adward/Downloads/fisheye.js"></script>

    <script>

	 d3.json("_users.json", function(error, graph) {
       var width = 960,
       height = 500;
       
       var fisheye = d3.fisheye.circular()
	   	.radius(200)
	   	.distortion(2);

       var color = d3.scale.category20();

       var force = d3.layout.force()
                            .charge(-120)
                            .linkDistance(30)
                            .size([width, height]);

       var svg = d3.select("body").append("svg")
                   .attr("width", width)
                   .attr("height", height);
                   

       force
                   .nodes(graph.nodes)
                   .links(graph.links)
                   .start();

       var link = svg.selectAll(".link")
                     .data(graph.links)
                     .enter().append("line")
                     .attr("class", "link")
                     .style("stroke-width", function(d) { return Math.sqrt(d.value); });

       var node = svg.selectAll(".node")
                     .data(graph.nodes)
                     .enter().append("circle")
                     .attr("class", "node")
                     .attr("r", 5)
                     .style("fill", function(d) { return color(d.group); })
                     .call(force.drag);

       node.append("title")
           .text(function(d) { return d.name; });

       force.on("tick", function() {
         link.attr("x1", function(d) { return d.source.x; })
             .attr("y1", function(d) { return d.source.y; })
             .attr("x2", function(d) { return d.target.x; })
             .attr("y2", function(d) { return d.target.y; });

         node.attr("cx", function(d) { return d.x; })
             .attr("cy", function(d) { return d.y; });
       });
       
       svg.on("mousemove", function() {
				   		fisheye.focus(d3.mouse(this));

				   		node.each(function(d) { d.fisheye = fisheye(d); })
				   			.attr("cx", function(d) { return d.fisheye.x; })
				   			.attr("cy", function(d) { return d.fisheye.y; })
				   			.attr("r", function(d) { return d.fisheye.z * 4.5; });

			   			link.attr("x1", function(d) { return d.source.fisheye.x; })
			   				.attr("y1", function(d) { return d.source.fisheye.y; })
			   				.attr("x2", function(d) { return d.target.fisheye.x; })
			   				.attr("y2", function(d) { return d.target.fisheye.y; });
		});
       
     });

     ////////////////////

     var margin = {top: 40, right: 10, bottom: 20, left: 10},
     width = 960 - margin.left - margin.right,
     height = 500 - margin.top - margin.bottom;

     var n = 3, // number of layers
 	 m = 24, // number of samples per layer
 	 yGroupMax,
 	 yStackMax,
 	 stack,
 	 layers,
 	 num = 4;

     d3.json("weibo1.json",function(error,root){

       /*function changeSource(){
	   num = $("#slider").slider("value");
       }*/
       stack = d3.layout.stack();
       layers = stack(d3.range(n).map(function(idx) { return bumpLayer(idx, m, .1); }));
       yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); });
       yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

       var x = d3.scale.ordinal()
    	               .domain(d3.range(m))
		               .rangeRoundBands([0, width], .08);

       var y = d3.scale.linear()
		               .domain([0, yStackMax])
		               .range([height, 0]);

       var color = d3.scale.linear()
    	                   .domain([0, n - 1])
		                   .range(["#aad", "#556"]);

       var xAxis = d3.svg.axis()
		                 .scale(x)
		                 .tickSize(0)
		                 .tickPadding(6)
		                 .orient("bottom");

       var svg = d3.select("body").append("svg")
                   .attr("width", width + margin.left + margin.right)
                   .attr("height", height + margin.top + margin.bottom)
                   .append("g")
                   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
       //.on("mouseover",function(){num=num+1; console.log(num);});

       var layer = svg.selectAll(".layer")
                      .data(layers)
                      .enter().append("g")
                      .attr("class", "layer")
                      .style("fill", function(d, i) { return color(i); });

       var rect = layer.selectAll("rect")
                       .data(function(d) { return d; })
                       .enter().append("rect")
                       .attr("x", function(d) { return x(d.x); })
                       .attr("y", height)
                       .attr("width", x.rangeBand())
                       .attr("height", 0);

       /*rect.transition()
       .delay(function(d, i) { return i * 10; })
       .attr("y", function(d) { return y(d.y0 + d.y); })
       .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); });*/

       svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

       d3.selectAll("input").on("change", change);

       //d3.selectAll($("#slide")).on("slide",function() {console.log("HI")} );

       var timeout = setTimeout(function() {
         d3.select("input[value=\"grouped\"]").property("checked", true).each(change);
       }, 2000);

       function change() {
         //clearTimeout(timeout);
         if (this.value === "grouped") transitionGrouped();
         else transitionStacked();
       }

       function transitionGrouped() {
         y.domain([0, yGroupMax]);

         rect.transition()
             .duration(500)
             .delay(function(d, i) { return i * 10; })
             .attr("x", function(d, i, j) { return x(d.x) + x.rangeBand() / n * j; })
             .attr("width", x.rangeBand() / n)
             .transition()
             .attr("y", function(d) { return y(d.y); })
             .attr("height", function(d) { return height - y(d.y); });
       }

       function transitionStacked() {
         y.domain([0, yStackMax]);

         rect.transition()
             .duration(500)
             .delay(function(d, i) { return i * 10; })
             .attr("y", function(d) { return y(d.y0 + d.y); })
             .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
             .transition()
             .attr("x", function(d) { return x(d.x); })
             .attr("width", x.rangeBand());
       }

       // Inspired by Lee Byron's test data generator.
       function bumpLayer(idx, n, o) {
         
         var a = [], i;
         for (i = 0; i < n; ++i) a[i] = i;
         //for (i = 0; i < 5; ++i) bump(a);
         //console.log($("#slider").slider("value"));
         if (idx==0){return a.map(function(d, i) { return {x: i, y: root["children"][num]["children"][i]["level0"]}; });}
         else if (idx==1){return a.map(function(d, i) { return {x: i, y: root["children"][num]["children"][i]["level1"]}; });}
         else {return a.map(function(d, i) { return {x: i, y: root["children"][num]["children"][i]["level2"]}; });}
       }
       
       $(function() {
		 var select = d3.select("svg");
		 var slider = $( "<div id='slider'></div>" ).insertAfter( select ).slider({
    	   //$( "#slider" ).slider({
	       orientation:"horizontal",
	       max:99,
	       value:44,
	       slide: function(event,ui){
		     num = ui.value;
		     layers = stack(d3.range(n).map(function(idx) { return bumpLayer(idx, m, .1); }));
		     yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); });
			 yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });
             
			 var x = d3.scale.ordinal()
    	                     .domain(d3.range(m))
		                     .rangeRoundBands([0, width], .08);

			 var y = d3.scale.linear()
		                     .domain([0, yStackMax])
		                     .range([height, 0]);
		     
		     d3.selectAll("g")
               .data(0)
               .exit()
               .remove();

             svg = d3.select("svg")
                     .attr("width", width + margin.left + margin.right)
                     .attr("height", height + margin.top + margin.bottom)
             //.append("g")
                     .attr("transform", "translate(" + margin.left + "," + margin.top + ")");         
             
             
             var layer = svg.selectAll(".layer")
                            .data(layers)
                            .enter().append("g")
                            .attr("class", "layer")
                            .style("fill", function(d, i) { return color(i); });

             //d3.select(("input[value=\"stacked\"]").property("checked",true));

             var rect = layer.selectAll("rect")
                             .data(function(d) { return d; })
                             .enter().append("rect")
                             .attr("x", function(d) { return x(d.x); })
                             .attr("y", height)
                             .attr("width", x.rangeBand())
                             .attr("height", 0);

             var xAxis = d3.svg.axis()
		                       .scale(x)
		                       .tickSize(0)
		                       .tickPadding(6)
		                       .orient("bottom");
		     
		     svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

             rect.transition()
                 .delay(function(d, i) { return i ; })
                 .attr("y", function(d) { return y(d.y0 + d.y); })
                 .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); });  
             
             d3.selectAll("input").on("change", change);
             
             //d3.selectAll($("#slide")).on("slide",function() {console.log("HI")} );

             var timeout = setTimeout(function() {
               d3.select("input[value=\"grouped\"]").property("checked", true).each(change);
             }, 2000);

             function change() {
               //clearTimeout(timeout);
               if (this.value === "grouped") transitionGrouped();
               else transitionStacked();
             }

             function transitionGrouped() {
               y.domain([0, yGroupMax]);

               rect.transition()
                   .duration(500)
                   .delay(function(d, i) { return i * 10; })
                   .attr("x", function(d, i, j) { return x(d.x) + x.rangeBand() / n * j; })
                   .attr("width", x.rangeBand() / n)
                   .transition()
                   .attr("y", function(d) { return y(d.y); })
                   .attr("height", function(d) { return height - y(d.y); });
             }

             function transitionStacked() {
               y.domain([0, yStackMax]);

               rect.transition()
                   .duration(500)
                   .delay(function(d, i) { return i * 10; })
                   .attr("y", function(d) { return y(d.y0 + d.y); })
                   .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
                   .transition()
                   .attr("x", function(d) { return x(d.x); })
                   .attr("width", x.rangeBand());
             }

    	     
		   }
    	 });
  	   });
  	   
     });
     
     

    </script>
  </head>
  <body>
	<div id="slider"></div>
  </body>

</html>


